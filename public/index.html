<!--     
    BardBoard - A DiscordJS bot soundboard
    Copyright (C) 2024  Giovanbattista Abbate
  
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
  
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
  
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>. 
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ BardBoard & Dragons üêâ</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Raleway:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        fetch('/env-config')
            .then(response => response.json())
            .then(config => { window.ENV = config; });
    </script>
</head>
<body>

    <!-- Ambient background particles -->
    <div class="ambient-bg" aria-hidden="true">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
    <header class="app-header">
        <div class="header-inner">
            <div class="brand">
                <span class="brand-icon">üéµ</span>
                <h1 class="brand-title">BardBoard <span class="ampersand">&amp;</span> Dragons</h1>
                <span class="brand-icon dragon">üêâ</span>
            </div>

            <nav class="controls" aria-label="Playback controls">
                <div class="volume-group">
                    <svg class="vol-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <input id="volumeSlider" type="range" min="0" max="100" step="1" value="50" aria-label="Volume">
                </div>

                <button id="repeatToggle" class="ctrl-btn ctrl-repeat" onclick="handleRepeatToggle()" aria-label="Toggle repeat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 014-4h14"></path>
                        <path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 01-4 4H3"></path>
                    </svg>
                    <span>Repeat</span>
                </button>

                <button id="stopButton" class="ctrl-btn ctrl-stop" aria-label="Stop">
                    <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"></rect></svg>
                    <span>Stop</span>
                </button>
            </nav>
        </div>

        <!-- Now-playing strip -->
        <div id="nowPlayingBar" class="now-playing-strip">
            <span class="np-pulse" aria-hidden="true"></span>
            <span class="np-label">Now Playing</span>
            <span class="np-divider">‚Ä∫</span>
            <span id="nowPlayingSong" class="np-song">Nothing playing</span>
        </div>
    </header>

    <!-- ‚îÄ‚îÄ Main soundboard ‚îÄ‚îÄ -->
    <main class="soundboard">
        <div id="audioButtons" class="track-grid"></div>
    </main>

    <!-- ‚îÄ‚îÄ Footer ‚îÄ‚îÄ -->
    <footer class="app-footer">
        <span>Made with ‚ô• by <a href="https://github.com/giabb" target="_blank" rel="noopener">giabb</a></span>
    </footer>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Scripts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
// -------------------------------------------------------
// Button generation
// -------------------------------------------------------
fetch('/audio-files')
    .then(r => r.json())
    .then(files => {
        const grid = document.getElementById('audioButtons');
        files.forEach((file, i) => {
            const name = file.replace(/\.[^/.]+$/, '');

            const btn = document.createElement('button');
            btn.className = 'track-btn';
            btn.style.animationDelay = `${i * 0.04}s`;
            btn.setAttribute('data-track', name);
            btn.setAttribute('aria-label', `Play ${name}`);

            btn.innerHTML = `
                <span class="track-label">${name}</span>
            `;

            btn.addEventListener('click', () => {
                playAudio(file);
                btn.classList.add('pressed');
                setTimeout(() => btn.classList.remove('pressed'), 200);
            });

            grid.appendChild(btn);
        });
    });

// -------------------------------------------------------
// API helpers
// -------------------------------------------------------
function playAudio(fileName) {
    fetch('/play-audio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileName, channelId: window.ENV.channelId })
    });
}

document.getElementById('stopButton').addEventListener('click', () => {
    fetch('/stop-audio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channelId: window.ENV.channelId })
    });
    updateNowPlaying();
});

let isRepeatEnabled = false;
function handleRepeatToggle() {
    isRepeatEnabled = !isRepeatEnabled;
    document.getElementById('repeatToggle').classList.toggle('active', isRepeatEnabled);

    fetch('/toggle-repeat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channelId: window.ENV.channelId })
    }).catch(err => console.error('toggle-repeat error:', err));
}

document.getElementById('volumeSlider').addEventListener('input', function () {
    fetch('/set-volume', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channelId: window.ENV.channelId, volume: this.value / 100 })
    }).catch(err => console.error('set-volume error:', err));
});

// -------------------------------------------------------
// Now-Playing polling & button highlight
// -------------------------------------------------------
function updateNowPlaying() {
    if (!window.ENV || !window.ENV.channelId) return;

    fetch('/now-playing?channelId=' + encodeURIComponent(window.ENV.channelId))
        .then(r => r.json())
        .then(data => {
            const songEl = document.getElementById('nowPlayingSong');
            const barEl  = document.getElementById('nowPlayingBar');

            document.querySelectorAll('.track-btn').forEach(b => b.classList.remove('playing'));

            if (data.song) {
                songEl.textContent = data.song;
                barEl.classList.add('has-song');
                document.querySelectorAll('.track-btn').forEach(b => {
                    if (b.dataset.track === data.song) b.classList.add('playing');
                });
            } else {
                songEl.textContent = 'Nothing playing';
                barEl.classList.remove('has-song');
            }
        })
        .catch(err => console.error('now-playing poll error:', err));
}

function syncRepeatState() {
    if (!window.ENV || !window.ENV.channelId) return;
    fetch('/repeat-status?channelId=' + encodeURIComponent(window.ENV.channelId))
        .then(r => r.json())
        .then(data => {
            isRepeatEnabled = !!data.repeatEnabled;
            document.getElementById('repeatToggle').classList.toggle('active', isRepeatEnabled);
        })
        .catch(err => console.error('repeat-status error:', err));
}

setInterval(updateNowPlaying, 2000);
setTimeout(() => { updateNowPlaying(); syncRepeatState(); }, 800);
</script>
</body>
</html>
